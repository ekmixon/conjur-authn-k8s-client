apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-cluster-prep-test
  labels:
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
  - name: {{ .Release.Name }}-test
    image: cyberark/conjur-k8s-cluster-test:edge
    command: ["/usr/local/bin/bats", "-t", "/tests/helm-test.bats"]
    envFrom: 
    - configMapRef: 
        name: {{ .Values.authnK8s.configMap.name }}
    volumeMounts:
    - mountPath: /tests
      name: tests
      readOnly: true
  serviceAccount: {{ .Values.authnK8s.serviceAccount.name }}
  volumes:
  - name: conjur-access-token
    emptyDir:
      medium: Memory
  - name: tests
    configMap:
      name: {{ .Release.Name }}-tests-configmap
  restartPolicy: Never
